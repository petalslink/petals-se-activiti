<?xml version="1.0" encoding="UTF-8"?>
<project name="PEtALS integration Activiti component tests"
         default="all"
         basedir="."
         xmlns:jmx="antlib:org.apache.catalina.ant.jmx">

   <taskdef resource="net/sf/antcontrib/antcontrib.properties" />
   <taskdef resource="org/ow2/petals/ant/petals-ant.properties" />

   <import>
      <javaresource name="org/ow2/petals/integration/ant/petals-esb.xml" classpath="${maven_plugin_classpath}" />
   </import>

   <basename property="petalsEsbDirName" file="${org.ow2.petals:petals-esb-default-zip:zip}" suffix=".zip" />
   <property name="petals.home"
             value="${project.build.directory}/${project.artifactId}/container/${petalsEsbDirName}" />
   <property name="topology.container.name" value="sample-0" />

   <!-- Properties -->
   <property name="host1.port" value="7700" />
   <property name="host1.ip" value="localhost" />
   <property name="host1.username" value="petals" />
   <property name="host1.password" value="petals" />
   <property name="activiti-db.file" value="/tmp/activiti.db" />

   <!-- Target : Prepare -->
   <target name="prepare">

      <jbi-install-shared-library file="${org.ow2.petals:petals-sl-postgresql-9.4-1201-jdbc4:jbi-shared-library}"
                                  port="${host1.port}"
                                  host="${host1.ip}"
                                  username="${host1.username}"
                                  password="${host1.password}" />
   </target>


   <!-- Target : Run -->
   <target name="run">

      <jmx:open url="service:jmx:rmi:///jndi/rmi://${host1.ip}:${host1.port}/jmxRmiConnector"
                username="${host1.username}"
                password="${host1.password}"
                echo="true" />

      <jmx:invoke name="Petals:name=Installation,type=service" echo="true" operation="loadNewInstaller">
         <arg value="file://${basedir}/deployables/petals-se-activiti.zip" />
      </jmx:invoke>

      <echo message="Set attribute 'jdbcDriver' to 'org.postgresql.Driver'" />
      <jmx:set name="org.ow2.petals:type=custom,name=bootstrap_petals-se-activiti"
               echo="true"
               attribute="jdbcDriver"
               value="org.postgresql.Driver" />
      <jmx:get name="org.ow2.petals:type=custom,name=bootstrap_petals-se-activiti"
               attribute="jdbcDriver"
               resultproperty="jdbc-driver" />
      <fail message="Unexpected value for the JDBC Driver">
         <condition>
            <not>
               <equals arg1="${jdbc-driver}" arg2="org.postgresql.Driver" />
            </not>
         </condition>
      </fail>
      
      <jmx:invoke name="org.ow2.petals:type=installer,name=petals-se-activiti" echo="true" operation="install" />

   </target>


   <!-- Target : Clean all -->
   <target name="cleanAll">
      <echo message="Cleaning Activiti component tests..." />

      <petals-stop-all-service-assemblies port="${host1.port}"
                                          host="${host1.ip}"
                                          username="${host1.username}"
                                          password="${host1.password}"
                                          failOnError="true" />
      <petals-shut-down-all-service-assemblies port="${host1.port}"
                                               host="${host1.ip}"
                                               username="${host1.username}"
                                               password="${host1.password}"
                                               failOnError="true" />
      <petals-undeploy-all-service-assemblies port="${host1.port}"
                                              host="${host1.ip}"
                                              username="${host1.username}"
                                              password="${host1.password}"
                                              failOnError="true" />

      <petals-stop-all-components port="${host1.port}"
                                  host="${host1.ip}"
                                  username="${host1.username}"
                                  password="${host1.password}"
                                  failOnError="true" />
      <petals-shut-down-all-components port="${host1.port}"
                                       host="${host1.ip}"
                                       username="${host1.username}"
                                       password="${host1.password}"
                                       failOnError="true" />
      <petals-uninstall-all-components port="${host1.port}"
                                       host="${host1.ip}"
                                       username="${host1.username}"
                                       password="${host1.password}"
                                       failOnError="true" />

      <petals-unload-all-installers port="${host1.port}"
                                    host="${host1.ip}"
                                    username="${host1.username}"
                                    password="${host1.password}"
                                    failOnError="true" />
   </target>

   <target name="launchContainer">
      <replaceregexp file="${petals.home}/conf/loggers.properties"
                     match="org.ow2.petals.log.handler.PetalsFileHandler.level.*"
                     replace="org.ow2.petals.log.handler.PetalsFileHandler.level=FINEST"
                     byline="true" />
      <replaceregexp file="${petals.home}/conf/loggers.properties"
                     match="Petals.Container.Components.level.*"
                     replace="Petals.Container.Components.level=FINEST"
                     byline="true" />

      <startContainer name="${topology.container.name}" home="${petals.home}" jmx.port="${host1.port}" />
   </target>

   <!-- Target : All -->
   <target name="all">
      <antcall target="killAllContainers" />
      <antcall target="launchContainer" />

      <antcall target="cleanAll" />

      <antcall target="prepare" />
      <antcall target="run" />

      <antcall target="cleanAll" />

      <stopContainer name="${topology.container.name}" home="${petals.home}" />

   </target>

</project>
